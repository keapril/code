# 開發計畫與進度記錄

## 📅 2026-01-27 完成項目

### ✅ 已完成的修正與優化

1. **R2 上傳頁面閃爍問題修復**
   - 增加「🚀 確認更新資料庫」按鈕，打斷 Streamlit 的無限 Rerun 迴圈
   - 優化資料載入邏輯為惰性載入（Lazy Loading）
   - 減少不必要的 R2 請求，提升操作流暢度

2. **檔案版本顯示功能**
   - 在 R2 中繼資料中存儲原始檔名
   - 在左側 Sidebar 顯示「Version: H_PX 20260123.xlsx」
   - 方便追蹤當前使用的資料版本

3. **高醫 Agilis NxT 院內碼重複問題修復**
   - 增強日期正則表達式，支援空格與橫線（如 `113 / 8 / 7`）
   - 實作區塊化解析，確保日期能正確歸屬於對應的院內碼
   - 透過日期優先邏輯排除舊的院內碼

4. **中國體系 610132/610133 配對問題修復**
   - 實作智慧括號配對邏輯 V2
   - 只有當括號內容完全吻合產品型號時才啟用精確配對
   - 確保 `#1809411(610132)` 只配對 610132，`#1809412(610133)` 只配對 610133

5. **分組日期優先邏輯**
   - 根據括號內容分組後再進行日期優先選擇
   - 不同括號內容代表不同產品，不應互相排除
   - 解決日期優先邏輯錯誤導致的院內碼消失問題

6. **全域日期優先去重邏輯**
   - 在 final_item 中加入日期資訊
   - 在去重前按日期降序排序
   - 根據「醫院+產品+型號」去重，保留日期最新的院內碼
   - 確保高醫等醫院不會顯示舊的院內碼

7. **requirements.txt 補齊**
   - 建立 `requirements.txt` 並補齊 `s3fs`、`pyarrow` 等必要套件
   - 解決 Streamlit Cloud 部署時的 ModuleNotFoundError

### 🛠️ 技術改進

- **日期解析增強**：支援 `113/8/7`、`113 / 8 / 7`、`113.8.7`、`113-8-7` 等多種格式
- **區塊化解析**：以 `#` 為分界點，確保每個院內碼的上下文完整
- **智慧配對**：根據產品型號清單動態判斷是否啟用精確配對
- **多層去重**：分組去重 + 全域去重，雙重保障資料正確性

---

## 🎯 下次開發的 3 件優先事項

### 1. 完整驗證與測試

- [ ] 重新上傳最新的 Excel 資料到系統
- [ ] 測試高醫 Agilis NxT：確認只顯示 `21869302`，無舊碼
- [ ] 測試中國體系 Angio Seal：確認 `610132 → 1809411`，`610133 → 1809412`
- [ ] 測試其他醫院的產品，確認無重複或消失問題
- [ ] 驗證檔案版本顯示功能是否正常

### 2. UI/UX 優化

- [ ] 優化初次載入速度（如有需要）
- [ ] 考慮增加「最近更新記錄」功能，顯示最近 5 次上傳的檔案版本
- [ ] 評估是否需要增加「院內碼歷史記錄」功能

### 3. 資料處理邏輯強化（視測試結果而定）

- [ ] 如發現其他特殊格式，調整解析邏輯
- [ ] 考慮增加「資料驗證報告」，上傳後自動檢查潛在問題
- [ ] 評估是否需要支援批次匯出功能

---

## 📝 已知問題與待確認事項

### 目前狀態

- ✅ R2 上傳閃爍問題已修復
- ✅ 高醫 Agilis NxT 重複問題已修復
- ✅ 中國體系 610132/610133 配對問題已修復
- ⏳ 等待使用者驗證最新部署結果

### 需要使用者確認

1. **最新部署驗證**
   - 確認高醫和中國體系的院內碼是否都正確
   - 確認檔案版本顯示功能是否正常
   - 確認上傳流程是否順暢（無閃爍）

---

## 🔧 技術細節記錄

### 關鍵修改的檔案

- `src/app.py` - 主程式邏輯（多次優化）
- `requirements.txt` - 新增套件依賴
- `.gitignore` - 排除敏感檔案

### 今日 Git 提交記錄

```
d4cbd4d - 修復高醫重複問題：實作全域日期優先去重邏輯
7d5cfcb - 修復 610132 消失問題：實作分組日期優先邏輯
4fd36e6 - 實作智慧括號配對邏輯 V2，修復中國體系院內碼配對錯誤
8625cc0 - 移除括號型號精確配對邏輯，修復中國體系 610132 消失問題
294028d - 修復高醫 Agilis NxT 院內碼重複、增加檔案版本記錄與修復 R2 上傳閃爍問題
f13b9cd - 建立 requirements.txt 並補齊 s3fs, pyarrow 等依賴
```

### 部署環境

- **平台**：Streamlit Cloud
- **儲存**：Cloudflare R2（Parquet 格式）
- **GitHub**：<https://github.com/keapril/code>
- **網址**：<https://southcode.streamlit.app/>

---

## 📅 2026-01-26 完成項目

### ✅ 已完成的修正與優化

1. **醫院白名單更新**
   - 根據 `H-list.txt` 更新 `PUBLIC_HOSPITALS` 清單
   - 確保所有南區醫院都在白名單中

2. **院內碼日期過濾邏輯修復**
   - 支援民國年格式（如 `113/01/15` → `2024/01/15`）
   - 優先選擇有日期且日期最新的院內碼
   - 解決高醫 Agilis NxT 等產品的院內碼判斷錯誤

3. **多型號組合搜尋修復**
   - 支援分號、逗號、換行拆分型號（如 `407449;407439;407441`）
   - 每個型號都能被單獨精準搜尋
   - 修復搜尋引擎的正則表達式問題（`regex=False`）

4. **括號內型號與院內碼配對邏輯**
   - 正確解析 `#1809411(610132)(祐新)` 格式
   - 將括號內的型號（如 `610132`）與對應院內碼配對
   - 支援一物一碼的查詢需求

5. **院內碼重複顯示問題修復**
   - 當院內碼有額外型號時，只建立一筆資料
   - 避免與產品型號交叉組合導致重複

6. **Git 倉庫初始化與部署**
   - 完成 Git 初始化與 GitHub 關連
   - 成功推送所有修正到 GitHub
   - Streamlit Cloud 自動部署設定完成

7. **資料儲存遷移**
   - 從 Firebase 遷移至 Cloudflare R2
   - 使用 Parquet 格式優化儲存效率
   - 解決 Firebase 流量限制問題

---

## 💡 備註

- 所有程式碼修正都已推送到 GitHub main 分支
- Streamlit Cloud 會自動偵測 GitHub 更新並重新部署（約 1-2 分鐘）
- 如果部署失敗，請檢查 Streamlit Cloud 的 Logs 查看錯誤訊息
- 記得定期備份 R2 的資料（Parquet 檔案）
- API 額度有限，修改前請先確認邏輯無誤再部署

---

**最後更新時間**：2026-01-27 16:49
